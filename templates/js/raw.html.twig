{# templates/_partials/hit_card.html.twig (Twig-JS compatible) #}
{% set cfg = {
    pk:        _config.primaryKey | default('id'),
    maxLen:    (_config.maxLen is defined) ? _config.maxLen : 120,
    maxList:   (_config.maxList is defined) ? _config.maxList : 6,
    prettyJson: (_config.prettyJson is defined) ? _config.prettyJson : true
} %}

{% set pkVal = attribute(hit, cfg.pk) is defined ? attribute(hit, cfg.pk) : (hit.id ?? null) %}
{% set collapseId = 'hit-' ~ (pkVal ?? random()) ~ '-more' %}
{% set shownCount = 8 %}

{# pick first image-ish URL (#jpg/#jpeg, querystring okay) #}
{% set imageUrl = null %}
{% for k, v in hit %}
    {% if imageUrl is null and (v is not iterable) and (v is not same as(null)) %}
        {% set s = (v)|lower %}
        {% if ('http://' in s or 'https://' in s) and ('.jpg' in s or '.jpeg' in s) %}
            {% set imageUrl = v %}
        {% endif %}
    {% endif %}
{% endfor %}

<div class="card h-100 shadow-sm border-0">

    <div class="card-body p-3">

        {% if imageUrl %}
            <img
                src="{{ imageUrl }}"
                alt="{{ hit.title|default('Image') }}"
                class="img-fluid d-block mx-auto rounded-top"
                loading="lazy" decoding="async"
                style="max-height:160px; width:auto; height:auto; max-width:100%;"
            >
        {% endif %}

        {% if hit.title ?? false %}
            <h5 class="card-title mb-2 text-wrap" style="white-space:normal; word-break:break-word;">
                {{ hit.title }}
            </h5>
        {% endif %}

        <ul class="list-unstyled mb-0">
            {# HEAD rows #}
            {% set rendered = 0 %}
            {% for var, val in hit %}
                {% if not (var starts with '_') and rendered < shownCount %}
                    {% set rendered = rendered + 1 %}

                    <li class="mb-2">
                        <div class="small text-muted mb-1" style="white-space:nowrap;">{{ var }}</div>

                        {# SCALAR ------------------------------------------------------- #}
                        {% if val is not iterable %}
                            {% set s = (val is not same as(null)) ? (val) : '' %}
                            {% if s starts with 'http://' or s starts with 'https://' %}
                                <a href="{{ s }}" target="_blank" rel="noreferrer"
                                   class="link-body-emphasis d-inline-block text-wrap"
                                   style="white-space:normal; word-break:break-word;"
                                   title="{{ s }}">{{ s }}</a>
                            {% else %}
                                {% set shown = (s|length > cfg.maxLen) ? s|slice(0, cfg.maxLen) ~ '…' : s %}
                                <span class="d-inline-block text-wrap"
                                      style="white-space:normal; word-break:break-word;"
                                      title="{{ s }}">{{ shown }}</span>
                            {% endif %}

                            {# ITERABLE (list vs complex) ----------------------------------- #}
                        {% else %}
                            {% set simpleList = true %}
                            {% set flat = [] %}
                            {% for item in val %}
                                {% if item is iterable %}
                                    {% set simpleList = false %}
                                {% else %}
                                    {% set flat = flat|merge([item]) %}
                                {% endif %}
                            {% endfor %}

                            {% if simpleList %}
                                {% set extra = (flat|length > cfg.maxList) ? (flat|length - cfg.maxList) : 0 %}
                                <div class="d-flex flex-wrap gap-1">
                                    {% for item in flat|slice(0, cfg.maxList) %}
                                        <span class="badge text-bg-secondary text-wrap"
                                              style="white-space:normal; word-break:break-word;"
                                              title="{{ item }}">{{ item }}</span>
                                    {% endfor %}
                                    {% if extra > 0 %}
                                        <span class="badge text-bg-light border text-wrap"
                                              style="white-space:normal; word-break:break-word;"
                                              title="{{ flat|slice(cfg.maxList)|join(', ') }}">+{{ extra }} more</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                {# pretty JSON (wrap, no horizontal scroll) #}
                                {% set j = (cfg.prettyJson ? (val|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_SLASHES'))) : (val|json_encode(constant('JSON_UNESCAPED_SLASHES')))) %}
                                <code class="d-block small text-wrap"
                                      style="white-space:pre-wrap; word-break:break-word;"
                                      title="{{ j }}">{{ j }}</code>
                            {% endif %}
                        {% endif %}
                    </li>
                {% endif %}
            {% endfor %}
        </ul>

        {# MORE rows in a collapse #}
        {% if rendered < (hit|length) %}
            <div class="collapse mt-2" id="{{ collapseId }}">
                <ul class="list-unstyled mb-0">
                    {% set rendered2 = 0 %}
                    {% for var, val in hit %}
                        {% if not (var starts with '_') and loop.index > shownCount %}
                            {% set rendered2 = rendered2 + 1 %}
                            <li class="mb-2">
                                <div class="small text-muted mb-1" style="white-space:nowrap;">{{ var }}</div>

                                {% if val is not iterable %}
                                    {% set s = (val is not same as(null)) ? (val) : '' %}
                                    {% if s starts with 'http://' or s starts with 'https://' %}
                                        <a href="{{ s }}" target="_blank" rel="noreferrer"
                                           class="link-body-emphasis d-inline-block text-wrap"
                                           style="white-space:normal; word-break:break-word;"
                                           title="{{ s }}">{{ s }}</a>
                                    {% else %}
                                        {% set shown = (s|length > cfg.maxLen) ? s|slice(0, cfg.maxLen) ~ '…' : s %}
                                        <span class="d-inline-block text-wrap"
                                              style="white-space:normal; word-break:break-word;"
                                              title="{{ s }}">{{ shown }}</span>
                                    {% endif %}
                                {% else %}
                                    {% set simpleList = true %}
                                    {% set flat = [] %}
                                    {% for item in val %}
                                        {% if item is iterable %}
                                            {% set simpleList = false %}
                                        {% else %}
                                            {% set flat = flat|merge([item]) %}
                                        {% endif %}
                                    {% endfor %}

                                    {% if simpleList %}
                                        {% set extra = (flat|length > cfg.maxList) ? (flat|length - cfg.maxList) : 0 %}
                                        <div class="d-flex flex-wrap gap-1">
                                            {% for item in flat|slice(0, cfg.maxList) %}
                                                <span class="badge text-bg-secondary text-wrap"
                                                      style="white-space:normal; word-break:break-word;"
                                                      title="{{ item }}">{{ item }}</span>
                                            {% endfor %}
                                            {% if extra > 0 %}
                                                <span class="badge text-bg-light border text-wrap"
                                                      style="white-space:normal; word-break:break-word;"
                                                      title="{{ flat|slice(cfg.maxList)|join(', ') }}">+{{ extra }} more</span>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        {% set j = (cfg.prettyJson ? (val|json_encode(constant('JSON_PRETTY_PRINT') b-or constant('JSON_UNESCAPED_SLASHES'))) : (val|json_encode(constant('JSON_UNESCAPED_SLASHES')))) %}
                                        <code class="d-block small text-wrap"
                                              style="white-space:pre-wrap; word-break:break-word;"
                                              title="{{ j }}">{{ j }}</code>
                                    {% endif %}
                                {% endif %}
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>

            <button class="btn btn-sm btn-outline-secondary mt-2"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#{{ collapseId }}"
                    aria-expanded="false"
                    aria-controls="{{ collapseId }}">
                Show more
            </button>
        {% endif %}
    </div>

    <div class="card-footer bg-transparent border-0 d-flex justify-content-between align-items-center flex-wrap gap-2">
        {# There will always be a primaryKey value #}
        {% set pkVal = attribute(hit, _config.primaryKey) %}
        <button
            {{ stimulus_action(globals._sc_modal, 'modal') }}
            data-hit-id="{{ pkVal }}"
            class="btn btn-sm btn-primary d-inline-flex align-items-center gap-1"
            title="View JSON details">
            {{ ux_icon('json')|raw }}
            <span class="ms-1">Details {{ pkVal }}</span>
        </button>

        {% if hit.url ?? false %}
            <a href="{{ hit.url }}" target="_blank" rel="noreferrer" class="btn btn-sm btn-outline-secondary">
                🔗 Open
            </a>
        {% endif %}
    </div>
</div>
